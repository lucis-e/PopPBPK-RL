---
title: "Gráficos_adicionales"
output: html_document
---

Material adicional para la generación de gráficas complementarias para el Trabajo de Fin de Grado: 'Diseño de regímenes de tratamiento optimizados en pacientes hipertensos con insuficiencia renal. Un enfoque desde el aprendizaje por refuerzo"

```{r}
library(readxl)
library(tidyr)
library(dplyr)
library(reshape)
library(ggplot2)
library(data.table)
```

ANALISIS DE CORRELACIÓN DE LAS VARIABLES CONTÍNUAS ABC Y Cmáx

Carga del conjunto de datos de 10.000 pacientes virtuales

```{r}
input<-'A2_DOK_10000patStrat_10mg_V01.xlsx'
datas<-read_excel(input) #amtropometric variables
datas
```

Distribución de las medidas de las variables farmacocinéticas a tiempo final (t = 7).

```{r}
pharma_data <- datas[c('p_no', 'AUCday7', 'Cmaxday7')]
colnames(pharma_data) <- c('p_no', 'ABC día 7', 'Cmáx día 7')

plot_data <- pharma_data %>% select(c('ABC día 7', 'Cmáx día 7')) %>% pivot_longer(everything(), names_to = 'Variable')
```

```{r}
#tiff("Distribución_ABC_Cmax_7.tiff", units="in", width=5, height=5, res=300)

  ggplot(data = plot_data, aes(x = value)) + geom_histogram(bins = 20, fill="#69b3a2", color="#e9ecef") + 
  facet_wrap(~ Variable,  scales = 'free') +
  labs(title = "Distribución de las variables farmacocinéticas contínuas", x="Valor", y="Nº de observaciones") + theme_bw() + theme(aspect.ratio = 0.75, plot.title=element_text(size=10,face="bold"),  axis.title=element_text(size=8))

#dev.off()
```

Test de correlación de Spearman (no paramétrico, no asume normalidad)
```{r}

#colnames(pharma_data)<-c('p_no', 'ABC', 'Cmáx')

tiff("corrABCCmax.tiff", units="in", width=5, height=5, res=300)

color <- rgb(9/255, 137/255, 134/255, maxColorValue = 1)
color2 <- rgb(253/255, 128/255, 174/255, maxColorValue = 1)
color3 <- rgb(255/255, 198/255, 51/255, maxColorValue = 1)

ggplot(pharma_data, mmaping=aes(x=ABC,y=Cmáx))+
geom_point(aes(x = ABC, y=Cmáx),size=1.2, colour=color, alpha=0.4)+
geom_smooth(aes(x=ABC,y=Cmáx),method='lm', color=color3, formula= y~x)+
#geom_line(data = data, aes_string(x = i, y=j), colour=colorr, size=0.65)+
labs(title=paste("ABC vs Cmáx"),subtitle="Spearman = 0.918") + theme_bw() + theme(aspect.ratio = 0.75)

#dev.off()

```



ANÁISIS DESCRIPTIVO UNIVARIABLE DE LOS PARÁMETROS SELECCIONADOS PARA LA ESTRATIFICACIÓN Y EL DISEÑO DEL MODELO COMPUTACIONAL

Distribución de las variables numéricas contínuas

```{r}
#tiff("test.tiff", units="in", width=5, height=5, res=300)

antrodata[, c('BMI', 'GFR')] %>%
  pivot_longer(everything(),names_to="cols",values_to="value") %>%
  ggplot(aes(x = value)) + geom_histogram(bins = 20, fill="#69b3a2", color="#e9ecef") + 
  facet_wrap(~ cols,  scales = 'free') +
  labs(title = "Distribución de las variables contínuas", x="Valor", y="Nº de observaciones") + theme_bw() + theme(aspect.ratio = 0.75)
  
#dev.off()

```








```{r}

# Gráficas de CMax y AUc frente a GFR, BMI y Sexo para ver como varian en función a esto

antrodata['.id'] <-patient_id
merged <- merge(unique_pharmadata, antrodata[c('.id', 'GFR', 'BMI')])



merged <- merged %>%
  mutate( GFRs = case_when(GFR >= 90 ~ 'Healthy',
                            GFR >= 60 ~ "Mild (90-60)",
                            GFR >= 45 ~ "Mild-moderate (59-45)",
                            GFR >= 30 ~ "Moderate (44-30)",
                            GFR >= 15 ~ "Severe (29-15)"))
       


ggplot(merged, mmaping=aes(x=AUC,y=Cmax))+
geom_point(aes(x = AUC, y=Cmax),size=1.2, colour=colorr, alpha=0.4)+
geom_smooth(aes(x=AUC,y=Cmax),method='lm', color=colorr3, formula= y~x)+
#geom_line(data = data, aes_string(x = i, y=j), colour=colorr, size=0.65)+
facet_wrap(~ GFRs, space = 'free') +
labs(title=paste("AUC vs GFR"),subtitle="Spearman = 0.95")

```





